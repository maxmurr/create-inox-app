ARG APP_NAME=web
ARG APP_PACKAGE=@repo/web

# Stage 1: Prune monorepo for the target app
FROM oven/bun:1.3.5-alpine AS pruner
WORKDIR /app

RUN bun install -g turbo@^2

COPY . .

ARG APP_PACKAGE
RUN turbo prune ${APP_PACKAGE} --docker

# Stage 2: Install dependencies (cached unless lockfile/manifests change)
FROM oven/bun:1.3.5-alpine AS installer
WORKDIR /app

COPY --from=pruner /app/out/json/ .
RUN bun install --frozen-lockfile --ignore-scripts

# Stage 3: Build the application
FROM oven/bun:1.3.5-alpine AS builder
WORKDIR /app

COPY --from=installer /app/ .
COPY --from=pruner /app/out/full/ .

ARG APP_PACKAGE
ARG SOURCE_VERSION=dev
ENV SOURCE_VERSION=${SOURCE_VERSION}
ENV DATABASE_URL=http://placeholder \
    REDIS_URL=http://placeholder{{#if hasAuth}} \
    BETTER_AUTH_SECRET=placeholder-secret-must-be-32-chars \
    BETTER_AUTH_URL=http://placeholder{{/if}}{{#if hasLangfuse}} \
    LANGFUSE_SECRET_KEY=placeholder \
    LANGFUSE_PUBLIC_KEY=placeholder \
    LANGFUSE_BASE_URL=http://placeholder{{/if}}{{#if isAiChatApp}} \
    OPENROUTER_API_KEY=placeholder{{/if}}
RUN bun run build -- --filter=${APP_PACKAGE}

ARG APP_NAME
{{#if hasDatabase}}
RUN cd apps/${APP_NAME} && \
    bun build lib/db/migrate.ts --target=node --outfile=migrate.mjs --external=pg-native && \
    bun build lib/db/seed.ts --target=node --outfile=seed.mjs --external=pg-native
{{/if}}

# Stage 4: Production runner
FROM node:22-alpine AS runner
WORKDIR /app

RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

ARG APP_NAME
ENV APP_NAME=${APP_NAME}

ARG SOURCE_VERSION=dev
ENV SOURCE_VERSION=${SOURCE_VERSION}

COPY --from=builder --chown=nextjs:nodejs /app/apps/${APP_NAME}/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/${APP_NAME}/.next/static ./apps/${APP_NAME}/.next/static
{{#if hasDatabase}}
COPY --from=builder --chown=nextjs:nodejs /app/apps/${APP_NAME}/migrate.mjs ./migrate.mjs
COPY --from=builder --chown=nextjs:nodejs /app/apps/${APP_NAME}/seed.mjs ./seed.mjs
COPY --from=builder --chown=nextjs:nodejs /app/apps/${APP_NAME}/migrations ./migrations
{{/if}}

USER nextjs

ENV NODE_ENV=production
ENV HOSTNAME=0.0.0.0
ENV PORT=3000

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD wget -qO- http://localhost:3000/api/health || exit 1

CMD node apps/${APP_NAME}/server.js
