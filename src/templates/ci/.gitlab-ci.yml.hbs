include:
  - project: "gitlab-ci/gitlab-ci-templates"
    ref: main
    file: "/deploy-v2/.gitlab-ci.yml"

stages:
  - validate
  - build
  - deploy

variables:
  BUILD_COMMIT_TAG: build-$CI_COMMIT_SHORT_SHA
  BUILD_BRANCH_TAG: build-$CI_COMMIT_REF_SLUG

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  auto_cancel:
    on_new_commit: interruptible

validate:
  stage: validate
  image: oven/bun:1.3.5
  interruptible: true
  tags:
    - docker
    - sidecar
  script:
    - bun install --frozen-lockfile --ignore-scripts
    - bun run check

build:
  stage: build
  image: docker:27.3-dind
  services: []
  interruptible: true
  needs: []
  tags:
    - docker
    - build-xlarge
  variables:
    BUILD_COMMIT_TAG: build-$CI_COMMIT_SHORT_SHA
    CACHE_BRANCH_TAG: branch-$CI_COMMIT_REF_SLUG
    CACHE_DEFAULT_TAG: branch-$CI_DEFAULT_BRANCH
    BUILD_TARGET: runner
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  before_script:
    - sh ./scripts/prebuild.sh
  script:
    - sh ./scripts/build.sh

{{#each environments}}
deploy:{{this.name}}:
  stage: deploy
  when: manual
  variables:
    PATCH_PATH: {{this.name}}
    PATCH_BRANCH: main
    PATCH_IMAGE: $CI_REGISTRY_IMAGE/{{../appName}}-web
    PATCH_IMAGE_TAG: build-$CI_COMMIT_SHORT_SHA
  environment:
    name: {{this.name}}
  extends: .trigger_job_template
{{/each}}
